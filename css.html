<style>
/* * みらいパスポート CSS v2.0 (Print System Unified)
 * Includes: Passport Animation, Plaza Layout, Evaluation Stamps, Optimized Print Styles
 */

/* ... (ルート変数、基本スタイル、アニメーションなどはv1.9.4と同じ) ... */
:root {
  --color-primary: #1a73e8;
  --color-primary-hover: #1557b0;
  --color-success: #34a853;
  --color-warning: #fbbc04;
  --color-danger: #ea4335;
  --bg-body: #f0f2f5;
  --bg-card: #ffffff;
  --bg-sidebar: #ffffff;
  --border-color: #dee2e6;
  --shadow-sm: 0 .125rem .25rem rgba(0,0,0,.075);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
  --p-width: 130px; --p-height: 180px; --p-radius: 12px; --p-offset: 65px;
  --pp-blue: #90caf9; --pp-pink: #f48fb1; --pp-orange: #ffab91; --pp-cyan: #80deea; --pp-shadow: rgba(144, 202, 249, 0.4);
}

/* Base Styles */
body { font-family: "Zen Maru Gothic", "M PLUS Rounded 1c", sans-serif; color: #3c4043; background-color: var(--bg-body); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
a { text-decoration: none; }
.btn { border-radius: 50rem; font-weight: 500; }
.form-control { border-radius: 0.5rem; }
.transition-all { transition: all 0.3s ease; }
.relative { position: relative; }

/* Loading & Passport Animation */
#loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
.scene { width: 300px; height: 300px; perspective: 1000px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.passport { width: var(--p-width); height: var(--p-height); position: relative; transform-style: preserve-3d; transform: rotateX(25deg) translateX(var(--p-offset)); animation: float 3s ease-in-out infinite; }
@keyframes float { 0%, 100% { transform: rotateX(25deg) translateX(var(--p-offset)) translateY(0); } 50% { transform: rotateX(25deg) translateX(var(--p-offset)) translateY(-10px); } }
.pp-sheet { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 4px var(--p-radius) var(--p-radius) 4px; transform-origin: left center; transform-style: preserve-3d; }
.back-plate { background-color: var(--pp-blue); transform: translateZ(-4px); box-shadow: 0 10px 20px var(--pp-shadow); border: 2px solid white; }
.base-left { background-color: #fff; transform: rotateY(-180deg) translateZ(2px); border-radius: var(--p-radius) 4px 4px var(--p-radius); border-right: 2px solid #e3f2fd; }
.base-right { background-color: #fff; transform: translateZ(0px); border-left: 2px solid #e3f2fd; }
.pp-face { position: absolute; top: 0; left: 0; width: 100%; height: 100%; backface-visibility: hidden; background-color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; border-radius: 4px var(--p-radius) var(--p-radius) 4px; border-left: 1px solid #e3f2fd; }
.pp-face.front { transform: rotateY(0deg); }
.pp-face.back { transform: rotateY(180deg); border-radius: var(--p-radius) 4px 4px var(--p-radius); border-left: none; border-right: 1px solid #e3f2fd; background-color: #fafafa; }
.flipping-page:nth-child(4) { animation: pageFlipLoop 5s linear infinite; animation-delay: 0s; }
.flipping-page:nth-child(5) { animation: pageFlipLoop 5s linear infinite; animation-delay: 1.66s; }
.flipping-page:nth-child(6) { animation: pageFlipLoop 5s linear infinite; animation-delay: 3.33s; }
.design-1 { background: radial-gradient(circle, var(--pp-pink) 10%, transparent 10%); background-size: 20px 20px; }
.design-2 { background: linear-gradient(45deg, var(--pp-cyan) 25%, transparent 25%, transparent 75%, var(--pp-cyan) 75%); background-size: 20px 20px; }
.design-3 { background: repeating-linear-gradient(0deg, var(--pp-orange), var(--pp-orange) 2px, transparent 2px, transparent 10px); }
@keyframes pageFlipLoop { 0% { transform: rotateY(0deg) translateZ(1px); z-index: 10; } 15% { transform: rotateY(-30deg) translateZ(10px); } 35% { transform: rotateY(-179.9deg) translateZ(1px); z-index: 10; } 36% { transform: rotateY(0deg) translateZ(0px); z-index: 1; opacity: 0; } 45% { opacity: 0; } 100% { opacity: 1; transform: rotateY(0deg) translateZ(0px); z-index: 1; } }
.loading-container { margin-top: 30px; text-align: center; transform: translateZ(50px); }
.loading-label { font-size: 1.1rem; font-weight: 800; color: #546e7a; font-family: 'M PLUS Rounded 1c', sans-serif; }
.loading-subtext { font-size: 0.85rem; color: #90a4ae; font-family: 'Zen Maru Gothic', sans-serif; }

/* Layout */
header.navbar { flex-shrink: 0; background-color: var(--bg-card) !important; border-bottom: 1px solid var(--border-color); z-index: 1030; box-shadow: var(--shadow-sm); }
.flex-grow-1 { display: flex; overflow: hidden; }
#sidebar { width: 320px; min-width: 320px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 1020; }
#mainBodyArea { position: relative; display: flex; width: 100%; overflow: hidden; }
main { flex-grow: 1; background-color: var(--bg-body); position: relative; display: flex; flex-direction: column; overflow: hidden; }
footer { flex-shrink: 0; background-color: var(--bg-card); border-top: 1px solid var(--border-color); z-index: 1040; }

/* Workspace & Editor */
#editorToolbar { flex-shrink: 0; margin: 1rem; padding: 0.5rem 1rem; background-color: var(--bg-card); border-radius: 50rem; box-shadow: var(--shadow-sm); display: flex; gap: 0.5rem; align-items: center; z-index: 100; }
.sheet-scroll-area { flex-grow: 1; overflow-y: auto; padding: 0 1rem 4rem 1rem; display: flex; justify-content: center; align-items: flex-start; scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }
.sheet-scroll-area::-webkit-scrollbar { width: 8px; }
.sheet-scroll-area::-webkit-scrollbar-track { background: transparent; }
.sheet-scroll-area::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
.sheet-container { width: 210mm; margin-top: 1rem; position: relative; transform-origin: top center; transition: transform 0.3s ease; box-shadow: var(--shadow-md); }
.sheet { background: white; width: 100%; min-height: 297mm; padding: 0; box-sizing: border-box; position: relative; z-index: 1; }
#worksheetContent { outline: none; font-size: 12pt; line-height: 1.6; color: #2c3e50; position: relative; z-index: 2; min-height: 297mm; }
.canvas-container { position: absolute !important; top: 0; left: 0; z-index: 10; pointer-events: auto; }

/* Worksheet Styles */
.ws-header { display: flex; justify-content: space-between; border-bottom: 2px solid #333; padding-bottom: 8px; margin-bottom: 25px; font-weight: bold; }
#worksheetContent h1 { font-size: 22pt; text-align: center; border-bottom: 3px double #333; padding-bottom: 15px; margin-bottom: 30px; margin-top: 10px; }
.ws-box { border: 2px solid #333; border-radius: 8px; padding: 15px; margin: 15px 0; min-height: 120px; background-color: #fff; position: relative; }
.ws-lines { background-image: linear-gradient(#ccc 1px, transparent 1px); background-size: 100% 2.5em; line-height: 2.5em; min-height: 150px; margin: 15px 0; position: relative; }
.table-bordered { border: 1px solid #333; }
.table-bordered td, .table-bordered th { border: 1px solid #333; }
.table-bordered th { background-color: #f8f9fa; text-align: center; }

/* Stamps */
.eval-btn { display: inline-flex; justify-content: center; align-items: center; width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ddd; color: #aaa; font-weight: bold; cursor: pointer; margin: 0 4px; user-select: none; transition: all 0.2s; pointer-events: auto !important; }
.eval-btn[data-val="3"].active { background-color: #fce4ec; color: #e91e63; border-color: #e91e63; transform: scale(1.1); }
.eval-btn[data-val="2"].active { background-color: #e3f2fd; color: #2196f3; border-color: #2196f3; transform: scale(1.1); }
.eval-btn[data-val="1"].active { background-color: #fffde7; color: #fbc02d; border-color: #fbc02d; transform: scale(1.1); }

/* Plaza & Student */
.scale-down-mode .sheet-container { transform: scale(0.65); margin-top: 0; transform-origin: top center; box-shadow: var(--shadow-sm); }
.scale-down-mode { background-color: #e3e8ec; }
#plazaPanel { background-color: #fff; z-index: 1010; box-shadow: -5px 0 15px rgba(0,0,0,0.05); }
body.student-mode header.navbar { background-color: #e8f5e9 !important; border-bottom: 1px solid #c8e6c9; }
body.student-mode .navbar-brand { color: #2e7d32 !important; }
body.student-mode #sidebar { display: none !important; }
body.student-mode main { background-color: #f1f8e9; }
body.student-mode .btn-primary { background-color: #43a047; border-color: #43a047; }
body.student-mode .btn-primary:hover { background-color: #2e7d32; }

/* ★ Print Styles (Unified System)
   NOTE: Actual print layout is controlled by the new window created in JS.
   These styles are applied within that print window.
*/
@media print {
  @page {
    size: A4;
    margin: 0; /* 余白ゼロで最大化 */
  }

  /* 画面上での印刷（Ctrl+P）対策: 全て非表示にする */
  /* 基本的にJSの Printer.run() 経由で印刷させるため、
     この画面自体を印刷しようとした場合は白紙になっても良いが、
     念のためメインコンテンツのみ表示する設定を残す */
  
  body * {
    visibility: hidden;
  }
  
  /* しかし、新しい印刷ウィンドウ内ではこれらが有効になる */
  .print-only-container, .print-only-container * {
    visibility: visible;
  }
  
  .print-only-container {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
  }

  /* 印刷用ウィンドウ向けのスタイル */
  .print-sheet {
    width: 100%;
    /* A4縦横比を維持しつつ、中身が多ければ伸びるように auto */
    height: auto; 
    min-height: 297mm;
    position: relative;
    background: white;
    padding: 10mm; /* 最小限の余白 */
    box-sizing: border-box;
    page-break-after: always;
    break-after: always;
    overflow: visible; /* スクロール部分も切れないように */
  }
  
  .print-sheet:last-child {
    page-break-after: auto;
    break-after: auto;
  }

  .print-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
  }

  /* 要素の途中での改ページ禁止 */
  .ws-box, .ws-lines, table, tr, .ws-header, h1 {
    break-inside: avoid;
    page-break-inside: avoid;
  }

  /* 背景色強制 */
  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  /* 評価スタンプなど */
  .eval-btn:not(.active) { opacity: 0.1; border-color: #eee; }
}
</style>
