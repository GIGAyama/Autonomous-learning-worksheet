<style>
/* =========================================
   1. テーマ変数 (Theme Variables)
   ========================================= */
:root {
  /* アプリのメインカラー */
  --color-primary: #1a73e8;
  --color-success: #34a853;
  --color-warning: #fbbc04;
  --color-danger: #ea4335;
  
  /* 背景色 */
  --bg-body: #f0f2f5;
  --bg-card: #ffffff;
  --bg-sidebar: #ffffff;
  --bg-loader: #ffffff;
  
  /* テキスト色 */
  --text-main: #3c4043;
  --text-muted: #6c757d;
  
  /* ボーダー・影 */
  --border-color: #dee2e6;
  --shadow-sm: 0 .125rem .25rem rgba(0,0,0,.075);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
  
  /* パスポートアニメーション用パレット */
  --pp-blue: #90caf9;
  --pp-pink: #f48fb1;
  --pp-orange: #ffab91;
  --pp-cyan: #80deea;
  --pp-shadow: rgba(144, 202, 249, 0.4);
  
  --p-width: 130px;
  --p-height: 180px;
  --p-radius: 12px;
  --p-offset: 65px;
}

/* =========================================
   2. ローディングアニメーション (Passport)
   ========================================= */
#loadingOverlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: var(--bg-loader);
  z-index: 9999;
  display: flex; justify-content: center; align-items: center; flex-direction: column;
}

.scene {
  width: 300px; height: 300px;
  perspective: 1000px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
}

/* パスポート本体 */
.passport {
  width: var(--p-width); height: var(--p-height);
  position: relative;
  transform-style: preserve-3d;
  transform: rotateX(25deg) translateX(var(--p-offset));
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: rotateX(25deg) translateX(var(--p-offset)) translateY(0); }
  50% { transform: rotateX(25deg) translateX(var(--p-offset)) translateY(-10px); }
}

/* ★修正: クラス名を .pp-sheet に変更して干渉を回避 */
.pp-sheet {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  border-radius: 4px var(--p-radius) var(--p-radius) 4px;
  transform-origin: left center;
  transform-style: preserve-3d;
}

/* 固定パーツ */
.back-plate {
  background-color: var(--pp-blue);
  transform: translateZ(-4px);
  box-shadow: 0 10px 20px var(--pp-shadow);
  border: 2px solid white;
}
.base-left {
  background-color: #fff;
  transform: rotateY(-180deg) translateZ(2px);
  border-radius: var(--p-radius) 4px 4px var(--p-radius);
  border-right: 2px solid #e3f2fd;
  box-shadow: inset -3px 0 8px rgba(144, 202, 249, 0.2);
}
.base-right {
  background-color: #fff;
  transform: translateZ(0px);
  border-left: 2px solid #e3f2fd;
  box-shadow: inset 3px 0 8px rgba(144, 202, 249, 0.2);
}

/* めくれるページ */
.flipping-page { z-index: 10; }

/* ★修正: クラス名を .pp-face に変更 */
.pp-face {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  backface-visibility: hidden;
  background-color: #fff;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  overflow: hidden;
  border-radius: 4px var(--p-radius) var(--p-radius) 4px;
  border-left: 1px solid #e3f2fd;
}
.pp-face.front { transform: rotateY(0deg); }
.pp-face.back {
  transform: rotateY(180deg);
  border-radius: var(--p-radius) 4px 4px var(--p-radius);
  border-left: none; border-right: 1px solid #e3f2fd;
  background-color: #fafafa;
}

/* ページ内デザイン */
.pattern-dot { position: absolute; border-radius: 50%; }
.pattern-bar { position: absolute; height: 5px; background-color: #e3f2fd; border-radius: 10px; }
.page-content { width: 100%; height: 100%; position: relative; }

/* デザインパターン */
.design-1 .pattern-dot.large { width: 50px; height: 50px; top: -15px; right: -15px; background-color: var(--pp-pink); opacity: 0.2; }
.design-1 .pattern-dot.small { width: 10px; height: 10px; bottom: 25px; left: 20px; background-color: var(--pp-pink); }
.design-1 .pattern-bar { bottom: 30px; left: 35px; width: 40%; background-color: #fce4ec; }

.design-2 .pattern-dot.large { width: 40px; height: 40px; bottom: 20px; right: 20px; border: 3px solid var(--pp-orange); opacity: 0.3; background: transparent; }
.design-2 .pattern-bar { top: 25px; left: 20px; width: 60%; background-color: #fbe9e7; }
.design-2 .pattern-bar:nth-child(3) { top: 35px; width: 40%; }

.design-3 .pattern-dot.large { width: 60px; height: 60px; top: 20px; left: -20px; background-color: var(--pp-cyan); opacity: 0.15; }
.design-3 .pattern-dot.small { width: 12px; height: 12px; top: 25px; right: 25px; background-color: var(--pp-cyan); }

/* アニメーションループ */
.flipping-page:nth-child(4) { animation: pageFlipLoop 5s linear infinite; animation-delay: 0s; }
.flipping-page:nth-child(5) { animation: pageFlipLoop 5s linear infinite; animation-delay: 1.66s; }
.flipping-page:nth-child(6) { animation: pageFlipLoop 5s linear infinite; animation-delay: 3.33s; }

@keyframes pageFlipLoop {
  0% { transform: rotateY(0deg) translateZ(1px); z-index: 10; }
  15% { transform: rotateY(-30deg) translateZ(10px); animation-timing-function: ease-in; }
  35% { transform: rotateY(-179.9deg) translateZ(1px); z-index: 10; }
  36% { transform: rotateY(0deg) translateZ(0px); z-index: 1; opacity: 0; }
  45% { opacity: 0; }
  100% { opacity: 1; transform: rotateY(0deg) translateZ(0px); z-index: 1; }
}

/* メッセージ */
.loading-container { margin-top: 30px; text-align: center; transform: translateZ(50px); }
.loading-label { font-size: 1.1rem; font-weight: 800; color: #546e7a; margin-bottom: 4px; font-family: 'M PLUS Rounded 1c', sans-serif; }
.loading-subtext { font-size: 0.85rem; color: #90a4ae; font-family: 'Zen Maru Gothic', sans-serif; }

/* =========================================
   3. アプリケーション本体スタイル
   ========================================= */
body {
  font-family: "Zen Maru Gothic", sans-serif;
  color: var(--text-main);
  background-color: var(--bg-body);
  height: 100vh;
  display: flex; flex-direction: column; overflow: hidden;
}

header.navbar {
  flex-shrink: 0;
  background-color: var(--bg-card) !important;
  border-bottom: 1px solid var(--border-color);
  z-index: 1030;
  box-shadow: var(--shadow-sm);
}

.flex-grow-1 { display: flex; overflow: hidden; }

#sidebar {
  width: 320px; min-width: 320px;
  background-color: var(--bg-sidebar);
  border-right: 1px solid var(--border-color);
  display: flex; flex-direction: column;
  z-index: 1020;
}

main {
  flex-grow: 1;
  background-color: var(--bg-body);
  position: relative;
  display: flex; flex-direction: column;
  overflow: hidden;
}

/* フッター */
footer {
  flex-shrink: 0;
  background-color: var(--bg-card);
  border-top: 1px solid var(--border-color);
  z-index: 1040;
}

/* =========================================
   4. エディタ & ワークシート
   ========================================= */
#editorToolbar {
  flex-shrink: 0; margin: 1rem; padding: 0.5rem 1rem;
  background-color: var(--bg-card); border-radius: 50rem;
  box-shadow: var(--shadow-sm); display: flex; gap: 0.5rem; align-items: center; z-index: 100;
}

.sheet-scroll-area {
  flex-grow: 1; overflow-y: auto; padding: 0 1rem 4rem 1rem;
  display: flex; justify-content: center; align-items: flex-start;
}

.sheet-container {
  width: 210mm; margin-top: 1rem; position: relative;
}

/* ★編集用シート (これが本来の .sheet) */
.sheet {
  background: white; width: 100%; min-height: 297mm;
  padding: 0; box-shadow: var(--shadow-md);
  box-sizing: border-box; position: relative; z-index: 1;
}

#worksheetContent {
  outline: none; font-size: 12pt; line-height: 1.6; color: #2c3e50;
  position: relative; z-index: 2; min-height: 297mm;
}

.canvas-container {
  position: absolute !important; top: 0; left: 0; z-index: 10; pointer-events: auto;
}

/* =========================================
   5. 生成コンテンツスタイル
   ========================================= */
.ws-header { display: flex; justify-content: space-between; border-bottom: 2px solid #333; padding-bottom: 8px; margin-bottom: 25px; font-weight: bold; }
h1 { font-size: 22pt; text-align: center; border-bottom: 3px double #333; padding-bottom: 15px; margin-bottom: 30px; }
.ws-box { border: 2px solid #333; border-radius: 8px; padding: 15px; margin: 15px 0; min-height: 120px; background-color: #fff; }
.ws-lines { background-image: linear-gradient(#ccc 1px, transparent 1px); background-size: 100% 2.5em; line-height: 2.5em; min-height: 150px; margin: 15px 0; }
.table-bordered th { background-color: #f8f9fa; }

/* =========================================
   6. ユーティリティ & 児童モード
   ========================================= */
.btn { border-radius: 50rem; font-weight: 500; }
.list-group-item.active { background-color: #e8f0fe; border-color: transparent; color: var(--color-primary); font-weight: bold; }
.list-group-item.active .text-muted { color: var(--color-primary) !important; opacity: 0.7; }

body.student-mode header.navbar { background-color: #e8f5e9 !important; border-bottom: 1px solid #c8e6c9; }
body.student-mode .navbar-brand { color: #2e7d32 !important; }
body.student-mode #sidebar { display: none !important; }
body.student-mode main { background-color: #f1f8e9; }

@media print {
  body * { visibility: hidden; }
  .sheet-container, .sheet-container * { visibility: visible; }
  .sheet-container { position: absolute; left: 0; top: 0; width: 100%; margin: 0; box-shadow: none; }
  #sidebar, header, #editorToolbar, footer { display: none !important; }
  @page { size: A4; margin: 0; }
}
</style>
