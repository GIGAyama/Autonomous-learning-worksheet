<script>
/**
 * ============================================================
 *  ã¿ã‚‰ã„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ v3.0.0 â€” å…ç«¥ãƒ¢ãƒ¼ãƒ‰ (js_student.html)
 * ============================================================
 *
 * â–  ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²
 *   å…ç«¥ï¼ˆå°å­¦ç”Ÿï¼‰ãŒä½¿ã†ç”»é¢ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®šç¾©ã—ã¾ã™ã€‚
 *   js_core.html ã§å®šç¾©ã•ã‚ŒãŸ App ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã€
 *   Object.assign ã§å…ç«¥å°‚ç”¨ã®é–¢æ•°ã‚’è¿½åŠ ã—ã¾ã™ã€‚
 *
 * â–  å«ã¾ã‚Œã‚‹æ©Ÿèƒ½
 *   1. å…ç«¥ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸåŒ–     â€” IDç®¡ç†ãƒ»è‡ªå‹•ä¿å­˜ãƒ«ãƒ¼ãƒ—ã®é–‹å§‹
 *   2. å›ç­”ã®ä¿å­˜ãƒ»æå‡º       â€” ä¸€æ™‚ä¿å­˜ï¼ˆdraftï¼‰ã¨æœ€çµ‚æå‡ºï¼ˆsubmittedï¼‰
 *   3. è‡ªå‹•ä¿å­˜               â€” 10ç§’ã”ã¨ã« LocalStorage ã¸ä¸‹æ›¸ãã‚’ä¿å­˜
 *   4. ã¿ã‚“ãªã®åºƒå ´ï¼ˆã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼‰â€” å‹é”ã®ä½œå“ã‚’é–²è¦§ãƒ»ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡
 *   5. ã‚³ãƒ³ãƒ‘ã‚¹é€£æº           â€” SOSãƒ»é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€šçŸ¥
 *   6. å…ç«¥ç”¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼       â€” ç”¨ç´™ä¸Šéƒ¨ã®ã‚¿ã‚¹ã‚¯åãƒ»æ“ä½œãƒœã‚¿ãƒ³
 *
 * â–  èª­ã¿è¾¼ã¿é †åº
 *   js_core.htmlï¼ˆApp å®šç¾©ï¼‰â†’ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ« â†’ js_teacher.html
 *
 * ============================================================
 */

Object.assign(App, {

  /* ==========================================================
   *  1. å…ç«¥ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸåŒ–
   * ==========================================================
   *
   * App.init() ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ã€‚ä»¥ä¸‹ã®å‡¦ç†ã‚’è¡Œã†:
   *   - å…ç«¥IDã®ç¢ºå®šï¼ˆã‚³ãƒ³ãƒ‘ã‚¹é€£æº or LocalStorage or æ–°è¦ç”Ÿæˆï¼‰
   *   - è‡ªå‹•ä¿å­˜ãƒ«ãƒ¼ãƒ—ã®é–‹å§‹ï¼ˆ10ç§’é–“éš”ï¼‰
   *   - ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿é–‹å§‹
   */

  /**
   * å…ç«¥ãƒ¢ãƒ¼ãƒ‰ã®èµ·å‹•å‡¦ç†
   *
   * @param {string} taskId      - é–‹ãèª²é¡Œã®IDï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ï¼‰
   * @param {string} studentId   - å…ç«¥IDï¼ˆã‚³ãƒ³ãƒ‘ã‚¹é€£æºæ™‚ã«è‡ªå‹•ä»˜ä¸ï¼‰
   * @param {string} studentName - å…ç«¥åï¼ˆã‚³ãƒ³ãƒ‘ã‚¹é€£æºæ™‚ã«è‡ªå‹•ä»˜ä¸ï¼‰
   */
  initStudentMode: async (taskId, studentId, studentName) => {

    // --- å…ç«¥IDã®ç¢ºå®š ---
    if (studentId && studentName) {
      // ã‚³ãƒ³ãƒ‘ã‚¹é€£æº: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¸¡ã•ã‚ŒãŸIDã¨åå‰ã‚’ä½¿ç”¨
      State.studentId = studentId;
      localStorage.setItem('manabi_sid', studentId);
      // åå‰å…¥åŠ›æ¬„ãŒã‚ã‚Œã°è‡ªå‹•å…¥åŠ›
      var nameInput = document.getElementById('studentNameInput');
      if (nameInput) nameInput.value = studentName;
    } else {
      // é€šå¸¸èµ·å‹•: LocalStorage ã‹ã‚‰å‰å›ã®IDã‚’å¾©å…ƒ
      State.studentId = localStorage.getItem('manabi_sid');
      if (!State.studentId) {
        // åˆå›ã‚¢ã‚¯ã‚»ã‚¹: æ–°ã—ã„IDã‚’ç”Ÿæˆã—ã¦ä¿å­˜
        State.studentId = 'S_' + Date.now() + Math.random().toString(36).substr(2, 5);
        localStorage.setItem('manabi_sid', State.studentId);
      }
    }

    // --- è‡ªå‹•ä¿å­˜ãƒ«ãƒ¼ãƒ—ã®é–‹å§‹ï¼ˆ10ç§’ã”ã¨ï¼‰ ---
    setInterval(App.autoSaveLocal, 10000);

    // --- ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ ---
    UI.showLoading("ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã‚’æº–å‚™ã—ã¦ã„ã¾ã™", "èª²é¡Œãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...");
    document.getElementById('appContainer').classList.remove('d-none');

    if (taskId) {
      // è¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚³ãƒ³ãƒ‘ã‚¹URLç­‰ãŒå¿…è¦ï¼‰â†’ ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã‚’é–‹ã
      await App.loadConfig();
      App.loadFromHistory(taskId);
    } else {
      UI.hideLoading();
      Swal.fire('ã‚¨ãƒ©ãƒ¼', 'èª²é¡ŒIDãŒç„¡åŠ¹ã§ã™ã€‚URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
    }
  },


  /* ==========================================================
   *  2. å›ç­”ã®ä¿å­˜ãƒ»æå‡º
   * ========================================================== */

  /**
   * å…ç«¥ã®å›ç­”ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã™ã‚‹
   *
   * ã€Œä¸€æ™‚ä¿å­˜ã€ãƒœã‚¿ãƒ³ â†’ status = 'draft'
   * ã€Œæå‡ºã€ãƒœã‚¿ãƒ³     â†’ status = 'submitted'
   *
   * é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿:
   *   - ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ç”»åƒã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆPNG, ä½è§£åƒåº¦ï¼‰
   *   - ã‚­ãƒ£ãƒ³ãƒã‚¹ã®JSONï¼ˆå¾Œã§å¾©å…ƒå¯èƒ½ãªå½¢å¼ï¼‰
   *   - è‡ªå·±è©•ä¾¡ãƒ†ã‚­ã‚¹ãƒˆï¼ˆâ— â—‹ â–³ ã®é¸æŠå†…å®¹ï¼‰
   *   - åºƒå ´ã¸ã®å…¬é–‹ãƒ•ãƒ©ã‚°
   *
   * â†’ æ›¸ãè¾¼ã¿å…ˆ: Responses ã‚·ãƒ¼ãƒˆï¼ˆcode.gs ã® saveStudentResponseï¼‰
   *
   * @param {string} status - 'draft'ï¼ˆä¸€æ™‚ä¿å­˜ï¼‰ã¾ãŸã¯ 'submitted'ï¼ˆæå‡ºï¼‰
   */
  submitStudentResponse: async (status) => {
    // åå‰ã®å–å¾—
    var nameInput = document.getElementById('studentNameInput');
    var name = nameInput ? nameInput.value : APP_CONFIG.studentName;

    // å…¬é–‹è¨­å®šã®å–å¾—
    var isPublicCheck = document.getElementById('isPublicCheck');
    var isPublic = isPublicCheck ? isPublicCheck.checked : true;

    // æå‡ºæ™‚ã¯åå‰å¿…é ˆ
    if (!name && status === 'submitted') {
      return Swal.fire('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', '', 'warning');
    }

    UI.showLoading(
      status === 'draft' ? "ä¸€æ™‚ä¿å­˜ä¸­..." : "æå‡ºã—ã¦ã„ã¾ã™",
      "å…ˆç”Ÿã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ä¸­..."
    );

    try {
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ç”»åƒã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆä½è§£åƒåº¦ã§è»½é‡åŒ–ï¼‰
      var img = "";
      if (State.fabricCanvas) {
        img = State.fabricCanvas.toDataURL({ format: 'png', multiplier: 0.5 });
      }

      // --- è‡ªå·±è©•ä¾¡ã®åé›† ---
      // ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆå†…ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ â— â—‹ â–³ ã®é¸æŠçŠ¶æ…‹ã‚’èª­ã¿å–ã‚‹
      var evalText = "";
      var rows = document.querySelectorAll('#worksheetContent table tr');
      rows.forEach(function(r) {
        var label = r.querySelector('td:first-child');
        var activeBtn = r.querySelector('.eval-btn.active');
        if (label && activeBtn) {
          evalText += '[' + label.innerText + ': ' + activeBtn.innerText + '] ';
        }
      });

      // --- ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ ---
      await Server.call('saveStudentResponse', {
        taskId:      State.currentTask.id,
        studentId:   State.studentId,
        studentName: name || "åç„¡ã—",
        canvasImage: img,
        canvasJson:  JSON.stringify(State.fabricCanvas ? State.fabricCanvas.toJSON() : {}),
        textContent: evalText,
        status:      status,
        isPublic:    isPublic
      });

      // --- æå‡ºå®Œäº†å¾Œã®å‡¦ç† ---
      if (status === 'submitted') {
        // ã‚³ãƒ³ãƒ‘ã‚¹ã«ã€Œå®Œäº†ã€ã‚’é€šçŸ¥
        App.notifyCompass('syncStatus', { status: 'done', mode: 'normal' });
        // ãƒ­ãƒ¼ã‚«ãƒ«ã®ä¸‹æ›¸ããƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        localStorage.removeItem('manabi_' + State.currentTask.id);
      }

      UI.toast(status === 'draft' ? "ä¿å­˜ã—ã¾ã—ãŸ" : "æå‡ºã—ã¾ã—ãŸï¼");
    } finally {
      UI.hideLoading();
    }
  },


  /* ==========================================================
   *  3. è‡ªå‹•ä¿å­˜ & å‰å›å›ç­”ã®å¾©å…ƒ
   * ========================================================== */

  /**
   * ã‚­ãƒ£ãƒ³ãƒã‚¹ã®çŠ¶æ…‹ã‚’ LocalStorage ã«è‡ªå‹•ä¿å­˜ã™ã‚‹
   * 10ç§’ã”ã¨ã« setInterval ã§å‘¼ã°ã‚Œã‚‹ã€‚
   *
   * ä¿å­˜å…ˆ: localStorage ã® 'manabi_{taskId}' ã‚­ãƒ¼
   * ä¿å­˜å½¢å¼: { j: ã‚­ãƒ£ãƒ³ãƒã‚¹JSON, t: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— }
   *
   * â€» ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã—ãªã„ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰
   * â€» æå‡ºæ™‚ã« LocalStorage ã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã‚‹
   */
  autoSaveLocal: () => {
    // å…ç«¥ãƒ¢ãƒ¼ãƒ‰ã§ã‚¿ã‚¹ã‚¯ãŒé¸æŠã•ã‚Œã‚­ãƒ£ãƒ³ãƒã‚¹ãŒã‚ã‚‹å ´åˆã®ã¿
    if (State.mode !== 'student' || !State.currentTask || !State.fabricCanvas) return;

    var key = 'manabi_' + State.currentTask.id;
    localStorage.setItem(key, JSON.stringify({
      j: State.fabricCanvas.toJSON(),
      t: Date.now()
    }));

    // ã€Œä¿å­˜æ¸ˆã€ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’æ›´æ–°
    var ind = document.getElementById('autoSaveIndicator');
    if (ind) ind.innerHTML = '<i class="bi bi-cloud-check"></i> ' + new Date().toLocaleTimeString();
  },

  /**
   * ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è‡ªåˆ†ã®å‰å›å›ç­”ã‚’èª­ã¿è¾¼ã‚€
   *
   * ã‚µãƒ¼ãƒãƒ¼ã«å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã‚Œã‚’å¾©å…ƒã—ã€
   * ãªã‘ã‚Œã° LocalStorage ã®ä¸‹æ›¸ãã‚’å¾©å…ƒã™ã‚‹ã€‚
   *
   * ã¾ãŸã€å…ˆç”Ÿã‹ã‚‰æ·»å‰Šï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰ãŒå±Šã„ã¦ã„ã‚‹å ´åˆã¯
   * é€šçŸ¥ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ã€‚
   *
   * â†’ èª­ã¿è¾¼ã¿å…ƒ: Responses ã‚·ãƒ¼ãƒˆï¼ˆcode.gs ã® getMyResponseï¼‰
   */
  loadMyResponse: async () => {
    var resp = await Server.call('getMyResponse', State.currentTask.id, State.studentId);

    if (resp) {
      // --- ã‚µãƒ¼ãƒãƒ¼ã«å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ ---
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®æç”»ã‚’å¾©å…ƒ
      if (resp.canvasJson && State.fabricCanvas) {
        State.fabricCanvas.loadFromJSON(resp.canvasJson);
      }

      // å…¬é–‹è¨­å®šãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å¾©å…ƒ
      var chk = document.getElementById('isPublicCheck');
      if (chk) chk.checked = (resp.isPublic === "" || resp.isPublic === true);

      // å…ˆç”Ÿã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒã‚ã‚‹å ´åˆ: é€šçŸ¥ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      if (resp.feedbackText || resp.status === 'graded') {
        var btn = document.getElementById('btnFeedback');
        if (btn) {
          btn.classList.remove('d-none');
          btn.onclick = function() {
            Swal.fire({
              title: 'å…ˆç”Ÿã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ',
              text: resp.feedbackText || "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆãªã—ï¼‰",
              icon: 'info'
            });
          };
          UI.toast("æ·»å‰ŠãŒå±Šã„ã¦ã„ã¾ã™");
        }
      }
    } else {
      // --- ã‚µãƒ¼ãƒãƒ¼ã«å›ç­”ãŒãªã„å ´åˆ: LocalStorage ã‹ã‚‰ä¸‹æ›¸ãã‚’å¾©å…ƒ ---
      var local = localStorage.getItem('manabi_' + State.currentTask.id);
      if (local && State.fabricCanvas) {
        State.fabricCanvas.loadFromJSON(JSON.parse(local).j);
        UI.toast("ä¸‹æ›¸ãã‚’å¾©å…ƒã—ã¾ã—ãŸ");
      }
    }
  },


  /* ==========================================================
   *  4. ã¿ã‚“ãªã®åºƒå ´ï¼ˆã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼‰
   * ==========================================================
   *
   * å‹é”ãŒæå‡ºã—ãŸãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã‚’é–²è¦§ã—ã€
   * ã‚¹ã‚¿ãƒ³ãƒ—ã‚„ã‚³ãƒ¡ãƒ³ãƒˆã§ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€ã‚‹æ©Ÿèƒ½ã€‚
   * ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œã¿ã‚“ãªã®åºƒå ´ã€ãƒœã‚¿ãƒ³ã§è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚
   */

  /**
   * åºƒå ´ãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
   *
   * è¡¨ç¤ºæ™‚: ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã‚’ç¸®å°ã—ã€å³å´ã«åºƒå ´ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
   * éè¡¨ç¤ºæ™‚: ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã‚’å…ƒã«æˆ»ã™
   *
   * @param {boolean} show - true ã§è¡¨ç¤ºã€false ã§éè¡¨ç¤º
   */
  toggleGalleryMode: async (show) => {
    State.isGalleryMode = show;

    var workspace = document.getElementById('workspaceContainer');
    var plaza     = document.getElementById('plazaPanel');
    var btnWork   = document.getElementById('btnModeWork');
    var btnPlaza  = document.getElementById('btnModePlaza');

    if (show) {
      // --- åºƒå ´ã‚’é–‹ã ---
      // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’åˆ‡æ›¿
      if (btnWork)  btnWork.classList.replace('btn-primary', 'btn-light');
      if (btnPlaza) btnPlaza.classList.replace('btn-light', 'btn-primary');
      // ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã‚’ç¸®å°
      if (workspace) workspace.classList.add('scale-down-mode');
      // åºƒå ´ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
      if (plaza) plaza.classList.remove('d-none');
      // å‹é”ã®ä½œå“ã‚’èª­ã¿è¾¼ã‚€
      await App.loadPlazaItems();
    } else {
      // --- åºƒå ´ã‚’é–‰ã˜ã‚‹ ---
      if (btnWork)  btnWork.classList.replace('btn-light', 'btn-primary');
      if (btnPlaza) btnPlaza.classList.replace('btn-primary', 'btn-light');
      if (workspace) workspace.classList.remove('scale-down-mode');
      if (plaza) plaza.classList.add('d-none');
    }
  },

  /**
   * åºƒå ´ã«è¡¨ç¤ºã™ã‚‹å‹é”ã®ä½œå“ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã™ã‚‹
   *
   * â†’ èª­ã¿è¾¼ã¿å…ƒ: Responses ã‚·ãƒ¼ãƒˆï¼ˆcode.gs ã® getSharedResponsesï¼‰
   *   å…¬é–‹è¨­å®šï¼ˆisPublicï¼‰ãŒ true ã‹ã¤æå‡ºæ¸ˆã¿ã®å›ç­”ã ã‘ãŒè¿”ã•ã‚Œã‚‹ã€‚
   *   è‡ªåˆ†ã®å›ç­”ã¯é™¤å¤–ã—ã¦è¡¨ç¤ºã™ã‚‹ã€‚
   */
  loadPlazaItems: async () => {
    var grid = document.getElementById('plazaGrid');
    if (!grid) return;

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    grid.innerHTML = '<div class="text-center w-100 py-5"><div class="spinner-border text-primary"></div></div>';

    try {
      var items = await Server.call('getSharedResponses', State.currentTask.id);
      grid.innerHTML = '';

      if (!items || items.length === 0) {
        grid.innerHTML = '<div class="col-12 text-center py-5 text-muted">ã¾ã èª°ã‚‚æå‡ºã—ã¦ã„ã¾ã›ã‚“</div>';
      } else {
        items.forEach(function(item) {
          // è‡ªåˆ†ã®å›ç­”ã¯è¡¨ç¤ºã—ãªã„
          if (item.studentId === State.studentId) return;

          var col = document.createElement('div');
          col.className = 'col-6';
          col.innerHTML =
            '<div class="card h-100 shadow-sm border-0" style="cursor:pointer; transition:transform 0.2s;" '
            + 'onmouseover="this.style.transform=\'scale(1.02)\'" onmouseout="this.style.transform=\'scale(1)\'">'
            + '<div class="bg-light d-flex align-items-center justify-content-center overflow-hidden position-relative" style="aspect-ratio: 210/297;">'
            + '<img src="' + item.canvasImage + '" class="img-fluid" style="object-fit:contain;">'
            + '</div>'
            + '<div class="card-footer bg-white border-top-0 py-1 px-2 text-center">'
            + '<small class="fw-bold text-truncate d-block">' + item.studentName + '</small>'
            + '</div></div>';
          col.onclick = function() { App.openPlazaDetail(item); };
          grid.appendChild(col);
        });
      }
    } catch(e) {
      grid.innerHTML = '<div class="col-12 text-center py-5 text-danger">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    }
  },

  /**
   * å‹é”ã®ä½œå“ã®è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹
   *
   * ä¸€è¦§è¡¨ç¤ºã‚’éš ã—ã¦ã€é¸æŠã—ãŸå‹é”ã®ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã‚’å¤§ããè¡¨ç¤ºã™ã‚‹ã€‚
   * Fabric.js ã§ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆæ‰‹æ›¸ãéƒ¨åˆ†ï¼‰ã‚‚å†ç¾ã™ã‚‹ã€‚
   *
   * @param {Object} item - å‹é”ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ï¼ˆgetSharedResponses ã®1ä»¶åˆ†ï¼‰
   */
  openPlazaDetail: (item) => {
    State.currentPeerResponse = item;
    if (!Array.isArray(item.reactions)) item.reactions = [];

    // ä¸€è¦§ â†’ è©³ç´°ã®è¡¨ç¤ºåˆ‡æ›¿
    document.getElementById('plazaGrid').classList.add('d-none');
    document.getElementById('plazaDetail').classList.remove('d-none');
    document.getElementById('plazaDetail').classList.add('d-flex');

    // å‹é”ã®åå‰ã‚’è¡¨ç¤º
    document.getElementById('plazaDetailName').innerText = item.studentName + ' ã•ã‚“ã®ä½œå“';

    // ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã®HTMLå†…å®¹ã‚’è¤‡è£½ã—ã¦è¡¨ç¤º
    var myContent = document.getElementById('worksheetContent').innerHTML;
    document.getElementById('plazaPeerContent').innerHTML = myContent;

    // --- å‹é”ã®æ‰‹æ›¸ããƒ‡ãƒ¼ã‚¿ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ï¼‰ã‚’å†ç¾ ---
    var cvEl = document.getElementById('plazaPeerCanvas');
    cvEl.width = 794;   // A4æ¨ªå¹…ã«ç›¸å½“ã™ã‚‹ãƒ”ã‚¯ã‚»ãƒ«
    cvEl.height = 1123;  // A4ç¸¦å¹…ã«ç›¸å½“ã™ã‚‹ãƒ”ã‚¯ã‚»ãƒ«

    // å‰ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒã‚ã‚Œã°ç ´æ£„
    if (State.peerCanvas) State.peerCanvas.dispose();

    // æ–°ã—ã„Fabricã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆï¼ˆé¸æŠä¸å¯ï¼é–²è¦§å°‚ç”¨ï¼‰
    State.peerCanvas = new fabric.Canvas('plazaPeerCanvas', { selection: false });

    if (item.canvasJson) {
      State.peerCanvas.loadFromJSON(item.canvasJson, function() {
        // å…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠä¸å¯ã«ã™ã‚‹ï¼ˆé–²è¦§å°‚ç”¨ï¼‰
        State.peerCanvas.forEachObject(function(o) { o.selectable = false; });
        State.peerCanvas.renderAll();
      });
    }

    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’è¡¨ç¤º
    App.renderPeerReactions(item.reactions);
  },

  /**
   * å‹é”ã®ä½œå“ã®è©³ç´°è¡¨ç¤ºã‚’é–‰ã˜ã¦ä¸€è¦§ã«æˆ»ã‚‹
   */
  closePlazaDetail: () => {
    document.getElementById('plazaDetail').classList.add('d-none');
    document.getElementById('plazaDetail').classList.remove('d-flex');
    document.getElementById('plazaGrid').classList.remove('d-none');
    State.currentPeerResponse = null;
  },

  /**
   * å‹é”ã®ä½œå“ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¹ã‚¿ãƒ³ãƒ—ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆï¼‰ã‚’é€ã‚‹
   *
   * â†’ æ›¸ãè¾¼ã¿å…ˆ: Responses ã‚·ãƒ¼ãƒˆã® Nåˆ—ï¼ˆcode.gs ã® savePeerReactionï¼‰
   *
   * @param {string} type  - 'stamp'ï¼ˆã‚¹ã‚¿ãƒ³ãƒ—ï¼‰ã¾ãŸã¯ 'comment'ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰
   * @param {string} value - ã‚¹ã‚¿ãƒ³ãƒ—ã®å ´åˆã¯çµµæ–‡å­—ã€ã‚³ãƒ¡ãƒ³ãƒˆã®å ´åˆã¯æœªä½¿ç”¨
   */
  sendReaction: async (type, value) => {
    if (!State.currentPeerResponse) return;
    if (!Array.isArray(State.currentPeerResponse.reactions)) {
      State.currentPeerResponse.reactions = [];
    }

    // ã‚³ãƒ¡ãƒ³ãƒˆã®å ´åˆã¯å…¥åŠ›æ¬„ã‹ã‚‰å€¤ã‚’å–å¾—
    var commentInput = document.getElementById('reactionComment');
    var val = (type === 'comment') ? commentInput.value : value;
    if (!val) return;

    // è‡ªåˆ†ã®åå‰ã‚’å–å¾—
    var nameInput = document.getElementById('studentNameInput');
    var myName = nameInput ? nameInput.value : 'è‡ªåˆ†';

    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
    var tempReaction = { type: type, value: val, fromName: myName };

    // ç”»é¢ã«å³åº§ã«åæ˜ ï¼ˆã‚µãƒ¼ãƒãƒ¼å¿œç­”ã‚’å¾…ãŸãªã„ï¼‰
    State.currentPeerResponse.reactions.push(tempReaction);
    App.renderPeerReactions(State.currentPeerResponse.reactions);

    // ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã‚’ã‚¯ãƒªã‚¢
    if (type === 'comment') commentInput.value = '';

    // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
    await Server.call('savePeerReaction', {
      taskId:           State.currentTask.id,
      targetResponseId: State.currentPeerResponse.responseId,
      reaction:         tempReaction
    });
    UI.toast('é€ã‚Šã¾ã—ãŸï¼');
  },

  /**
   * ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’ç”»é¢ã«æç”»ã™ã‚‹ï¼ˆæœ€æ–°5ä»¶ã®ã¿è¡¨ç¤ºï¼‰
   *
   * @param {Object[]} list - ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é…åˆ— [{ type, value, fromName }, ...]
   */
  renderPeerReactions: (list) => {
    var div = document.getElementById('peerReactionsList');
    div.innerHTML = '';
    if (!Array.isArray(list) || list.length === 0) return;

    // æœ€æ–°5ä»¶ã ã‘è¡¨ç¤º
    list.slice(-5).forEach(function(r) {
      var d = document.createElement('div');
      d.className = 'border-bottom py-1';
      d.innerHTML = '<span class="fw-bold me-2">' + r.fromName + '</span> ' + r.value;
      div.appendChild(d);
    });
  },


  /* ==========================================================
   *  5. ã¿ã‚‰ã„ã‚³ãƒ³ãƒ‘ã‚¹é€£æºï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€šçŸ¥ï¼‰
   * ==========================================================
   *
   * ã¿ã‚‰ã„ã‚³ãƒ³ãƒ‘ã‚¹ï¼ˆå¤–éƒ¨LMSï¼‰ã¨é€£æºã—ã¦ã„ã‚‹å ´åˆã€
   * å…ç«¥ã®å­¦ç¿’çŠ¶æ³ï¼ˆä½œæ¥­ä¸­ãƒ»SOSãƒ»é›†ä¸­ãƒ»å®Œäº†ï¼‰ã‚’
   * ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å…ˆç”Ÿå´ã«é€šçŸ¥ã—ã¾ã™ã€‚
   *
   * â†’ é€ä¿¡å…ˆ: code.gs ã® syncToCompass â†’ compassUrl ã¸ POST
   */

  /**
   * ã‚³ãƒ³ãƒ‘ã‚¹ã¸é€šçŸ¥ã‚’é€ã‚‹ï¼ˆFire-and-forgetï¼é€ã‚Šã£ã±ãªã—ï¼‰
   *
   * ã‚³ãƒ³ãƒ‘ã‚¹URL ãŒæœªè¨­å®šã®å ´åˆã‚„å…ç«¥ãƒ¢ãƒ¼ãƒ‰ä»¥å¤–ã§ã¯ä½•ã‚‚ã—ãªã„ã€‚
   * é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯é€šçŸ¥ã—ãªã„ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ï¼‰ã€‚
   *
   * @param {string} action - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¨®åˆ¥ï¼ˆä¾‹: 'syncStatus'ï¼‰
   * @param {Object} data   - è¿½åŠ ãƒ‡ãƒ¼ã‚¿ï¼ˆä¾‹: { status: 'done', mode: 'normal' }ï¼‰
   */
  notifyCompass: async (action, data) => {
    if (!data) data = {};

    // é€ä¿¡æ¡ä»¶: ã‚³ãƒ³ãƒ‘ã‚¹URLè¨­å®šæ¸ˆã¿ & å…ç«¥ID ã‚ã‚Š & å…ç«¥ãƒ¢ãƒ¼ãƒ‰
    if (!App.config || !App.config.compassUrl || !State.studentId) return;
    if (State.mode !== 'student') return;

    // å…ç«¥ã®åå‰ã‚’å–å¾—
    var nameInput = document.getElementById('studentNameInput');
    var studentName = nameInput ? nameInput.value : '';

    // é€ä¿¡ã™ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’çµ„ã¿ç«‹ã¦
    var payload = {
      action:      action,
      studentId:   State.studentId,
      studentName: studentName,
      taskId:      State.currentTask ? State.currentTask.id : '',
      taskTitle:   State.currentTask ? State.currentTask.title : '',
      timestamp:   new Date().getTime()
    };
    // è¿½åŠ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸
    var keys = Object.keys(data);
    for (var i = 0; i < keys.length; i++) {
      payload[keys[i]] = data[keys[i]];
    }

    // ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é€ä¿¡ï¼ˆã‚¨ãƒ©ãƒ¼ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¨˜éŒ²ã™ã‚‹ã ã‘ï¼‰
    Server.call('syncToCompass', payload)
      .then(function(res) {
        if (!res.success) console.warn("Sync Warning:", res.error);
      })
      .catch(function(e) {
        console.error("Sync Failed:", e);
      });
  },

  /**
   * å…ç«¥ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆé †èª¿ / é›†ä¸­ / SOSï¼‰ã‚’å¤‰æ›´ã™ã‚‹
   *
   * ãƒ˜ãƒƒãƒ€ãƒ¼ã® ğŸ‘ ğŸ”¥ ğŸ†˜ ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ã€‚
   * ã‚³ãƒ³ãƒ‘ã‚¹ã«é€šçŸ¥ã‚’é€ã‚Šã€ç”»é¢ã«ãƒˆãƒ¼ã‚¹ãƒˆã§çŠ¶æ…‹ã‚’è¡¨ç¤ºã™ã‚‹ã€‚
   *
   * @param {string} mode - 'normal'ï¼ˆé †èª¿ï¼‰/ 'focus'ï¼ˆé›†ä¸­ï¼‰/ 'sos'ï¼ˆSOSï¼‰
   */
  changeStudentStatus: (mode) => {
    // ã‚³ãƒ³ãƒ‘ã‚¹ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é€šçŸ¥
    App.notifyCompass('syncStatus', { mode: mode, status: 'working' });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
    var msg, icon;
    if (mode === 'sos') {
      msg = 'SOSã‚’ç™ºä¿¡ã—ã¾ã—ãŸ';
      icon = 'warning';
    } else if (mode === 'focus') {
      msg = 'é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ';
      icon = 'info';
    } else {
      msg = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è§£é™¤ã—ã¾ã—ãŸ';
      icon = 'info';
    }
    UI.toast(msg, icon);
  },


  /* ==========================================================
   *  6. å…ç«¥ç”¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼
   * ==========================================================
   *
   * ç”¨ç´™ã®ä¸Šéƒ¨ã«ã‚¿ã‚¹ã‚¯åã¨æ“ä½œãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ã€‚
   * selectTask / loadFromHistory ã§ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿å¾Œã«å‘¼ã°ã‚Œã‚‹ã€‚
   */

  /**
   * å…ç«¥ç”¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’ç”¨ç´™å†…ã«è¡¨ç¤ºã™ã‚‹
   *
   * ã‚¿ã‚¹ã‚¯åãƒ»SOSãƒœã‚¿ãƒ³ãƒ»é›†ä¸­ãƒœã‚¿ãƒ³ãƒ»æå‡ºãƒœã‚¿ãƒ³ã‚’å«ã‚€ã€‚
   * æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ä¸€åº¦å‰Šé™¤ã—ã¦ã‹ã‚‰å†ä½œæˆã™ã‚‹ã€‚
   */
  renderStudentToolbar: () => {
    var container = document.getElementById('paperArea');
    if (!container) return;

    // æ—¢å­˜ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤
    var existing = document.getElementById('student-toolbar');
    if (existing) existing.remove();

    // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼HTMLè¦ç´ ã®ä½œæˆ
    var toolbar = document.createElement('div');
    toolbar.id = 'student-toolbar';
    toolbar.className = 'd-flex justify-content-between align-items-center mb-3 bg-white p-2 rounded shadow-sm sticky-top';
    toolbar.style.top = '10px';
    toolbar.style.zIndex = '1000';

    toolbar.innerHTML =
      '<div class="fw-bold text-primary px-2">'
      + '<i class="bi bi-pencil-square me-2"></i>'
      + (State.currentTask ? State.currentTask.title : 'ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆ')
      + '</div>'
      + '<div class="d-flex gap-2">'
      + '<button class="btn btn-outline-danger rounded-pill px-3 btn-sm fw-bold" onclick="App.changeStudentStatus(\'sos\')">'
      + '<i class="bi bi-exclamation-circle-fill me-1"></i>SOS</button>'
      + '<button class="btn btn-outline-info rounded-pill px-3 btn-sm fw-bold" onclick="App.changeStudentStatus(\'focus\')">'
      + '<i class="bi bi-lightning-fill me-1"></i>é›†ä¸­</button>'
      + '<button class="btn btn-success rounded-pill px-4 btn-sm fw-bold shadow-sm" onclick="App.submitStudentResponse(\'submitted\')">'
      + '<i class="bi bi-send-fill me-1"></i>æå‡º</button>'
      + '</div>';

    // ã‚³ãƒ³ãƒ†ãƒŠã®æœ€ä¸Šéƒ¨ã«æŒ¿å…¥
    container.insertBefore(toolbar, container.firstChild);
  },

  /**
   * å…ˆç”Ÿã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤ºã™ã‚‹
   * ï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®é€šçŸ¥ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
   */
  showFeedback: () => {
    // btnFeedback ã® onclick ã§å‹•çš„ã«ã‚»ãƒƒãƒˆã•ã‚Œã‚‹ãŸã‚ã€
    // ã“ã“ã§ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ã®ã¿å®šç¾©
    Swal.fire({
      title: 'å…ˆç”Ÿã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ',
      text: 'ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“',
      icon: 'info'
    });
  }
});
</script>
